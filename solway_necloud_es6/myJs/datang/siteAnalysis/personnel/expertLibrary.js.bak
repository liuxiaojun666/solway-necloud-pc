app.directive('elDetails', ['myAjaxData', '$ocLazyLoad', (myAjaxData, $ocLazyLoad) => ({
    restrict: 'E',
    template: $('#el-details').html(),
    scope: {
        detail: '='
    },
    link ($scope, $element) {
        
    }
})])


app.directive('elChart', ['myAjaxData', '$ocLazyLoad', (myAjaxData, $ocLazyLoad) => ({
    restrict: 'E',
    scope: {
        detail: '=',
        name: '='
    },
    link($scope, $element, $attrs) {
        const myChart = echarts.init($element[0])
        const renderChart = () => {
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: "{a} <br/>{b} : {c} ({d}%)"
                },
                series: [{
                    name: '损失电量构成',
                    center: [ '50%', '50%' ],
                    radius: [ '25%', '50%' ],
                    type: 'pie',
                    data: [30, 50, 34, 6, 34, 74,23, 26, 4].slice(0, myAjaxData.config[$scope.name].length).map((v, i) => ({
                        name: myAjaxData.config[$scope.name][i],
                        value: v,
                        label: {
                            normal: {
                                textStyle: {
                                    color: '#3f3f3f',
                                    fontSize: 14
                                }
                            }
                        },
                        itemStyle: {
                            normal: {
                                color: ['#ffc275', '#fff075', '#7ede44', '#4fbfe3', '#656cf8', '#cd80e9'][i]
                            },
                        },
                        hoverAnimation: false
                    }))
                }]
            }
            myChart.setOption(option)
        }

        renderChart()
    }
})])

ajaxData({
    pageList: {
        name: 'GETExpertLibrary',
        data: {
            powerType: 'PV',
            idType: 1,
            pageIndex:0,
            pageSize:10
        }
    },
    detail: {
        name: 'GETselectEqPaintingData',
        later: true
    },
    province: {
        name: 'POSTSelectProvince',
        data: {
            parentId: 1,
            treeLevel: 1
        }
    }
},{
    gzName: ['塔筒及基础', '变桨系统', '测风系统', '电控系统', '机械传动系统', '发电机'],
    ppName: ['西门子', '远景', 'GE', '葛美凤', '华创', '金风'],
    xhName: ['jj-1550', 's2000', 'k2000', 'm500'],
})('expertLibraryCtrl', ['$scope', 'myAjaxData'], ($scope, myAjaxData) => {
    $scope.dateTime1 = new Date((new Date).setDate((new Date).getDate() - 7))
    $scope.dateTime2 = new Date

    $scope.powerType = 'PV';
    $scope.changePowerType = type => $scope.powerType = type;
    $scope.idType = 1;
    $scope.brandIds = [];
    $scope.faultTypeIds = [];
    // 所有省份  + 集团
    $scope.province.promise.then(res => $scope.allIds = res.map(v => ({ [v.id]: v.regionName })).reduce((obj, cur) => ({ ...obj, ...cur }), { 1: '集团' }));

    $scope.conditionSearch = () =>{
        $scope.pageList.getData({
            powerType: $scope.powerType,
            idType:$scope.idType,
            ids:$scope.ids,
            brandIds:$scope.brandIds,
            faultTypeIds:$scope.faultTypeIds,
            keyword:$scope.keyword,
            pageIndex: 0,
            pageSize: 10
        })
    }

    // 改变  范围 执行 函数  重新请求 数据 汇总
    $scope.changeIds = value => {
        if (value === $scope.ids) return;
        const isJT = value == 1; // 选择的是否是集团
        $scope.idType = isJT ? 1 : 2;
        $scope.ids = isJT ? null : value;
        $scope.conditionSearch();
    }; 

    $scope.showDetails = (a, e) => {
        $('.el-details').show()
    }
    $(document).on('click.el', () => $('.el-details').hide())
})