$(function () {
    if ((location.host.split(':')[1] + '').indexOf('88') < 0) return;

    let documentLoaded = false;
    let dragIn = false;
    const download = (url, callback = () => { }) => {
        const oReq = new XMLHttpRequest();
        oReq.open("GET", url, true);
        oReq.responseType = "blob";
        oReq.onload = function (oEvent) {
            if (oReq.response.size === 0 || oReq.status === 404) {
                if (confirm(' 文件为空或不存在，确定继续执行吗？')) __fun();
                return callback();
            } else __fun();


            function __fun() {
                const _blob = new Blob([oReq.response]);
                const reader = new FileReader();
                reader.onload = function (event) {
                    const content = reader.result;
                    callback(content);
                };
                reader.readAsText(_blob);
            }
        };
        oReq.send();
    };

    const drag = $(`<div>帮助<br/>文档</div>`).css({
        position: 'fixed',
        textAlign: 'center',
        width: '50px',
        height: '50px',
        right: '10px',
        bottom: '50px',
        borderRadius: '50%',
        background: '#376295',
        zIndex: '10',
        color: '#fff',
        border: '1px solid #fff',
        cursor: 'pointer',
        lineHeight: '20px',
        paddingTop: '5px',
        'moz-user-select': '-moz-none',
        '-moz-user-select': 'none',
        '-o-user-select': 'none',
        '-khtml-user-select': 'none',
        '-webkit-user-select': 'none',
        '-ms-user-select': 'none',
        'user-select': 'none',
    })[0];

    drag.onmousedown = function (event) {
        var event = event || window.event;  //兼容IE浏览器
        let diffX = event.clientX - drag.offsetLeft;
        let diffY = event.clientY - drag.offsetTop;
        drag.setCapture && drag.setCapture();

        function doc_onmousemove (event) {
            dragIn = true;
            let moveX = event.clientX - diffX;
            let moveY = event.clientY - diffY;
            if (moveX < 0) {
                moveX = 0;
            } else if (moveX > window.innerWidth - drag.offsetWidth) {
                moveX = window.innerWidth - drag.offsetWidth;
            }
            if (moveY < 0) {
                moveY = 0;
            } else if (moveY > window.innerHeight - drag.offsetHeight) {
                moveY = window.innerHeight - drag.offsetHeight;
            }
            drag.style.left = moveX + 'px';
            drag.style.top = moveY + 'px';
        };

        function doc_onmouseup (event) {
            if (!dragIn) dragClick();
            document.removeEventListener('mousemove', doc_onmousemove);
            document.removeEventListener('mouseup', doc_onmouseup);
            drag.releaseCapture && drag.releaseCapture();
            dragIn = false;
        };
        
        document.addEventListener('mousemove', doc_onmousemove);
        document.addEventListener('mouseup', doc_onmouseup);
    };

    function dragClick (event) {
        if (documentLoaded) return document.getElementById('aboutDoc').style.display = 'block';
        download('/tpl/publicComponent/aboutDoc.html', function (dom) {
            $('body').append(dom);
            var script = document.createElement("script");
            script.type = "text/javascript";
            script.src = 'theme/js/dist/aboutDoc/doc.js';
            document.getElementsByTagName("head")[0].appendChild(script);
            documentLoaded = true;
        });
    }

    document.body.appendChild(drag);
});

