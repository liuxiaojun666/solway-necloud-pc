ajaxData({
    businessManagementData: {
        name: 'GETbusinessManagementData',
        data: {},
        later: true
    },
    selectProvince:{
        name: 'POSTSelectProvince',
        data: {},
        later: true
    },
    update:{
        name:'POSTbusinessManagementSave',
        data: {},
        later: true,
        onlyLatest: true
    }
}, {
    __serviceName__: 'editBusManageTplService',
})('editBusManageTplCtrl', ['$scope', 'editBusManageTplService', 'actionRecord','$timeout','toaster'], ($scope, myAjaxData, historicalRecord,$timeout,toaster) => {

    $scope.enterpriseTypeList = [
        {id:32,dictName:'国有企业'},
        {id:33,dictName:'股份制企业'},
        {id:34,dictName:'私营企业'},
        {id:35,dictName:'联营企业'},
        {id:36,dictName:'外商投资企业'},
        {id:37,dictName:'港、澳、台'},
        {id:38,dictName:'股份合作企业'},
        {id:39,dictName:'集体所有制'}
    ];

    $scope.endDate = new Date('2099');

    const clearData = () =>{
        $scope.formData = {};
        $scope.customConfig = {};
        $scope.admintime = null;

    }

    const getData = () =>{
        clearData();
        $scope.businessManagementData.getData({}).then(res=>{
            if (res.key==2) {
                const data = res.data;

				$scope.customConfig = res.customConfig;
                $scope.formData = data;
                $scope.admintime = new Date(data.admintime);

                console.log(res.data)
     
                getProvence();
            }
        });
    }

    const getProvence = ()=>{
        $scope.selectProvince.getData({
            treeLevel:1,
            parentId:1
        }).then(res=>{
            $scope.provinceList = res;
            getCity();
        });
        
    }

    const getCity = () =>{
        if(!$scope.formData.provinceid) return;
        $scope.selectProvince.getData({
            treeLevel:2,
            parentId:$scope.formData.provinceid
        }).then(res=>{
            $scope.cityList = res;
            getCountry();
        });
    }

    const getCountry = () =>{
        if(!$scope.formData.cityid) return;
        $scope.selectProvince.getData({
            treeLevel:3,
            parentId:$scope.formData.cityid
        }).then(res=>{
            $scope.countryList = res;
        });
    }

    $scope.$on('broadEdit',()=>{
        getData();
    });

    //省change
    $scope.provinceChange = () =>{
        $scope.cityList = [];
        $scope.countryList = [];
        $scope.formData.cityid = '';
        $scope.formData.countyid = '';
        getCity();
    }

    //市change
    $scope.cityChange = ()=>{
        $scope.countryList = [];
        $scope.formData.countyid = '';
        getCountry();
    }

    function commonUploadImg(inputId,showPlaceId,dataObj,dataParams){
        $(document).on('change', '#'+inputId, function() {
            $.ajaxFileUpload({
                url: 'uploadImage/uploadImageFrom.htm', //用于文件上传的服务器端请求地址
                secureuri: false, //是否需要安全协议，一般设置为false
                fileElementId: inputId,
                formName: "file",
                dataType: 'json', //返回值类型 一般设置为json
                data: {"nodeId":inputId},
                success: function (data){
                    if (data.key==0) {
                        $("#"+showPlaceId).attr("src", data.path);
                        if(dataObj){
                            $scope[dataObj][dataParams] = data.path;
                            $scope.$apply();
                        }
                    }
                }
            });
        });
    }

    $timeout(()=>{
        //登录页logo上传
        commonUploadImg('updateLogolg','showLogolg','customConfig','logo_lg');
        commonUploadImg('updateLogosm','showLogosm','customConfig','logo_sm');
        commonUploadImg('updateLogo','showLogo','formData','logo');
        commonUploadImg('updateIdMsg','showIdMsg','','');
    },0);

    //删除上传图片
    $scope.deleteImg = (dataObj,dataParams,showPlaceId) =>{
        $('#'+showPlaceId).attr('src', '');
		delete $scope[dataObj][dataParams];
    }

    $scope.radioCheck = num =>{
        $scope.customConfig.logo_sm_flag = num;
    }

    //保存
    $scope.save = () =>{

        if(!$scope.customConfig.logo_sm) delete $scope.customConfig.logo_sm_flag;
     
        // $scope.update.getData({
        //     data: $scope.formData,
        //     customConfig : JSON.stringify($scope.customConfig)
        // }).then(res=>{
        //     console.log(res)
        //     if (res.key==3) {//企业名称不合法
        //         toaster.pop('error', '','企业名称不合法')
        //     };
        //     if (res.key==4) {//企业类型至少选一个
        //         toaster.pop('error', '','校验企业类型必选其一')
        //     };
        //     if (res.key==1) {
        //         // $('#clickRoute').trigger('click');
        //     };
        // })

        // $.post('Company/updateInfo.htm', {
        //     data: $scope.formData,
        //     customConfig : JSON.stringify($scope.customConfig)
        // }, function(res) {
		// 	console.log(res)
        //     if (res.key==3) {//企业名称不合法
        //         toaster.pop('error', '','企业名称不合法')
        //     };
        //     if (res.key==4) {//企业类型至少选一个
        //         toaster.pop('error', '','校验企业类型必选其一')
        //     };
        //     if (res.key==1) {
        //         // $('#clickRoute').trigger('click');
        //     };
        // });
        
    }

    // //取消
    // $scope.cancel = () =>{
    //     $scope.$emit('cancelCallback');
    // }

});