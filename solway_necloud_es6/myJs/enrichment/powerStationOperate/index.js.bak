ajaxData({
    // 显示所有电站详情（按照集团分组）
    StationRunStatusNew: {
        name: 'GETStationRunStatusNew',
        data: {},
        later: true
    },
    // 获取集团列表
    selectAllByAdmin: {
        name: 'selectAllByAdmin',
        data: {}
    },
}, {
        stid: null
    })('powerStationOperateCtrl', ['$scope', 'myAjaxData', 'actionRecord', '$timeout', 'toaster', '$interval'], ($scope, myAjaxData, historicalRecord, $timeout, toaster, $interval) => {
        $scope.moduleName = '电站运行';//当前页面名称

        //集团点击全选
        $scope.allChecked = true;
        $scope.getAllGroup = () => {
            $scope.groupList.forEach(item => {
                item.checked = $scope.allChecked ? true : false;
            });
        }

        //查询按钮  获取选中的集团
        $scope.comIds = [];
        $scope.getCheckedGroup = () => {
            $scope.comIds = $scope.allChecked ? [] : $scope.groupList.filter(item => item.checked).map(item => item.comId);
            $scope.getList();
            $scope.searchShow = false;
        }

        //取消选中按钮
        $scope.cancelChecked = (e) => {
            e.stopPropagation();
            // $scope.allChecked = false;
            // $scope.groupList.forEach(item => {
            //     item.checked = false;
            // });
            $scope.searchShow = false;
        }

        //获取集团列表
        $scope.selectAllByAdmin.subscribe(res => {
            $scope.groupList = res;
            $scope.groupList.forEach(item => {
                item.checked = false;
            });
            // 集团默认全选
            $scope.getAllGroup();
        });

        //刷新按钮
        $scope.refresh = () => {
            $scope.getList();
        }

        $scope.statusArr = [
            {
                'checked': true,
                'value': 0
            },
            {
                'checked': true,
                'value': 1
            },
            {
                'checked': true,
                'value': 2
            },
            {
                'checked': true,
                'value': 3
            },
            {
                'checked': true,
                'value': 4
            },
            {
                'checked': true,
                'value': 5
            },
            {
                'checked': true,
                'value': 6
            },
        ]

        //-----------------------------------获取电站详情 (默认获取全部)
        //状态的全选按钮
        $scope.powerStatusCheckAll = true;
        $scope.statusCheckAll = () => {
            $scope.statusArr.forEach(item => {
                item.checked = $scope.powerStatusCheckAll ? true : false;
            })
            $scope.getList();
        }

        //单个的状态多选按钮
        $scope.statusCheck = () => {
            $scope.getList();
        }

        //获取电站
        $scope.getList = () => {
            $scope.loading = true;
            var checkedStatus = [];
            $scope.statusArr.forEach(item => {
                if (item.checked) {
                    checkedStatus.push(item.value)
                }
            })

            $scope.StationRunStatusNew.getData({
                comIds: $scope.comIds.join(),
                status: checkedStatus.join()
            })

            $scope.StationRunStatusNew.subscribe(res => {
                $scope.loading = false;
                $scope.powerSt = res.body;
                $scope.powerStAll = [];
                $scope.foldFlag = false;
                $scope.powerSt.date.forEach(item => {
                    item.srs.forEach(son=>{
                        son.shortName = son.stationName.substr(0,4);
                    })
                    $scope.powerStAll.push(...item.srs);
                })
                // $scope.powerSt.date.forEach(item => {
                //     if (item.srs.length > 102) {
                //         item.srs.forEach((son, i) => {
                //             if (i > 102) {
                //                 son.show = false;
                //             }
                //         })
                //     }
                // })
            });
        }
        $scope.getList();

        //切换 按照集团显示
        $scope.isGroupShow = true;
        $scope.changeInputAbsent = () => {
            $scope.isGroupShow = !$scope.isGroupShow;
        }

        //切换 显示站名
        $scope.showPowerName = true;
        $scope.showNameAbsent = () => {
            $scope.showPowerName = !$scope.showPowerName;
            $scope.foldFlag = false;
        }
        
        //点击电站方块 - 弹出添加事件组件
        $scope.addEvent = false;
        $scope.addEventFun = (item) => {
            $scope.addEvent = true;
            $scope.$broadcast('powerStInfo', item);
        }

        //点击电站运行事件 - 弹出电站运行事件表格
        $scope.eventListShow = false;
        $scope.openList = () => {
            $scope.eventListShow = true;
            $scope.$broadcast('eventList');
        }

        // 搜索按钮
        $scope.searchShow = false;
        $scope.showSearchModel = (e) => {
            e.stopPropagation();
            $scope.searchShow = true;
        }

        $scope.keep = (e) => {
            e.stopPropagation();
        }

        document.addEventListener('click', eventListen);
        function eventListen() {
            $scope.searchShow = false;
            $scope.$apply();
        }

        //折叠电站方块
        $scope.foldFlag = false;
        $scope.fold = (item) => {
            if(!$scope.showPowerName){
                item.srs.forEach((v, i) => {
                    if (i > 101) {
                        v.show = !v.show;
                    }
                })
            } else {
                item.srs.forEach((v, i) => {
                    if (i > 50) {
                        v.show = !v.show;
                    }
                })
            }
            
            $scope.foldFlag = !$scope.foldFlag;
        }

        // 接收事件列表的返回按钮   电站详情子组件 取消按钮
        $scope.$on('eventListHide', (event, v) => {
            $scope.eventListShow = false;
            $scope.addEvent = false;
        })

        //定时刷新
        const interval = $interval(() => {
            $scope.getList();
        }, 10000);

        $scope.$on('$destroy', () => {
            $interval.cancel(interval);
        });

        //头部折叠框 显示
        $timeout(() => {
            $('.ng-clock').removeClass('ng-clock');
        }, 2000);

    });