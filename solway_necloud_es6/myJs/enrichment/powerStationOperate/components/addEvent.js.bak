ajaxData({
    // 单个电站的基础信息
    StationRunStatusDetail: {
        name: 'GETStationRunStatusDetail',
        data: {},
        later: true
    },
    // 添加事件
    insertDeviceEventDetail: {
        name: 'insertDeviceEventDetail',
        data: {},
        later: true
    },
    // 电站事件列表
    DeviceEventDetail: {
        name: 'GETDeviceEventDetail',
        data: {},
        later: true
    },

}, {})('addEventCtrl', ['$scope', 'myAjaxData', 'actionRecord', '$timeout', 'toaster', '$interval'], ($scope, myAjaxData, historicalRecord, $timeout, toaster, $interval) => {
    // Unix时间戳转换
    function FormatDateTime(UnixTime) {
        var a = UnixTime.replace("/Date(", "").replace(")/", "");
        var date = new Date(parseInt(a));
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var d = date.getDate();
        d = d < 10 ? ('0' + d) : d;
        return y + '-' + m + '-' + d;
    };

    //获取电站的item
    const commKey = {
        0: '正常',
        1: '中断',
        2: '初始化'
    }
    const statusKey = {
        '1': '故障',
        '2': '报警',
        '-99': '未知',
        '99': '正常'
    }
    const evShowKey = {
        0: '不显示',
        1: '显示'
    }
    const evStatusKey = {
        0: '关闭',
        1: '未关闭'
    }
    
    $scope.$on('powerStInfo', (event, v) => {
        $scope.formData = {};
        $scope.stid = v.stid;
        $scope.StationRunStatusDetail.getData({
            stid: v.stid,
            stClass: v.stClass
        })

        $scope.StationRunStatusDetail.subscribe(res => {
            $scope.powerStInfo = res.body;
            $scope.powerStInfo.updateTimeFormat = FormatDateTime($scope.powerStInfo.updateTime.toString());
            $scope.powerStInfo.statusFormat = $scope.powerStInfo.Comm == 0 ? statusKey[$scope.powerStInfo.status] : '';
            $scope.powerStInfo.CommFormat = commKey[$scope.powerStInfo.Comm];
            $scope.powerStInfo.real_powerFormat = $scope.powerStInfo.real_power == 0 || !$scope.powerStInfo.real_power ? $scope.powerStInfo.real_power : $scope.powerStInfo.real_power.toFixed(10);
        });
        // 获取事件列表
        getList();
    })

    // 获取事件列表
    var getList = () => {
        $scope.DeviceEventDetail.getData({
            stid: $scope.stid
        })

        $scope.DeviceEventDetail.subscribe(res => {
            $scope.powerStList = res.body;
            $scope.powerStList.forEach(item => {
                item.startDateFormat = item.startDate ? FormatDateTime(item.startDate.toString()) : '';
                item.endDateFormat = item.endDate ? FormatDateTime(item.endDate.toString()) : '';
                item.showFormat = evShowKey[item.show];
                item.statusFormat = evStatusKey[item.status];
            });
        });
    }

    // 时间范围选择
    $scope.GroupUser = {
        date: new Date,
        startDate: new Date,
        endDate: new Date
    }
    $scope.GroupUser.startDate.showDate = '';
    $scope.GroupUser.endDate.showDate = '';
    
    // 保存按钮
    $scope.formData = {
        show: '',
        status: ''
    }
    $scope.showData = [
        {
            k: 0, v: '不显示'
        },
        {
            k: 1, v: '显示'
        }
    ]
    $scope.statusData = [
        {
            k: 0, v: '关闭'
        },
        {
            k: 1, v: '未关闭'
        }
    ]

    //输入事件 确定按钮
    $scope.save = () => {
        if (!$solway.formValidation($scope.formData, '.addEvent', toaster)) return; //校验非空
        $scope.insertDeviceEventDetail.getData({
            stid: $scope.stid,
            title: $scope.formData.title,
            detail: $scope.formData.detail,
            startDate: $scope.GroupUser.startDate.showDate,
            endDate: $scope.GroupUser.endDate.showDate,
            show: $scope.formData.show,
            status: $scope.formData.status
        })

        $scope.insertDeviceEventDetail.subscribe(res => {
            if(res.code == 0){
                toaster.pop('success', '', '添加成功');
                $scope.formData = {};
                getList();
            } else {
                toaster.pop('error', '', '添加失败');
            }
        });
    }

    //取消按钮
    $scope.cancel = () => {
        $scope.$emit('eventListHide');
    }
});