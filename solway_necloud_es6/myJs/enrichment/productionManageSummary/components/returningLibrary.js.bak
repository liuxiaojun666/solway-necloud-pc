ajaxData(
    {
        // 还库 清单
        opFittingsRebackGoods: {
            name: 'GETopFittingsRebackGoods',
            data: {},
            later: true
        },
        // 出库 分页
        opWorkFittingsOutPage: {
            name: 'GETopWorkFittingsOutPage',
            data: {},
            later: true
        },
        // 出库 清单
        opWorkFittingsOutGoods: {
            name: 'GETopWorkFittingsOutGoods',
            data: {},
            later: true
        },
        // 库房列表  单个设备 库房中的数量
        opFittingsDictRoomSelectByFD: {
            name: 'GETopFittingsDictRoomSelectByFD',
            data: {},
            later: true,
            cache: true
        },
        // 还库 创建
        opFittingsRebackCreate: {
            name: 'opFittingsRebackCreate',
            data: {},
            later: true,
            sameTimeOnce: true
        },
    }, {
        __serviceName__: 'themeReturnLibraryService'
    }
)('themeReturnLibraryCtrl', ['$scope', 'themeReturnLibraryService', 'toaster', '$ocLazyLoad'], ($scope, myAjaxData, toaster, $ocLazyLoad) => {

    $scope.$on('popUp', (event, obj) => {
        const { tabIndex } = $scope;
        if (tabIndex !== 4) return;

        $scope.down = true;

        $scope.workedObj = [];

        $scope.obj = obj;

        $scope.opWorkFittingsOutPage.res = null;
        $scope.rcolumn = [];

        if (obj) {

            $scope.lookOver = true;

            $scope.opFittingsRebackGoods.getData({ id: obj.id });

        } else {

            $scope.lookOver = false;

            $scope.searchObj = {
                startDate: new Date(Date.now() - 1000 * 24 * 60 * 60 * 365),
                endDate: new Date
            };

            $scope.opWorkFittingsOutPage.getData({ 
                pageIndex: 0, 
                pageSize: 999, 
                states: '00', 
                out2reback: '1' 
            });
        }

    });


    $scope.opWorkFittingsOutPage.subscribe(res => {
        $('#rMyTable tbody tr.tr-click').removeClass('active');
        $scope.workedObj = [];
        $scope.obj = void 0;
        $scope.rdatasource = res.body.data;
        $scope.rdatasource[0] && $scope.rtrClick($scope.rdatasource[0], 0);
        $scope.rcolumn = [
            {
                title: '',
                dataIndex: 'createUname',
                align: 'center'
            },
            {
                title: '',
                dataIndex: 'sn',
                align: 'left'
            },
            {
                title: '',
                dataIndex: 'modifyTime',
                align: 'center',
                render(text, item) {
                    if (item.state !== '00') return '';
                    return new Date(text).Format('yyyy-MM-dd');
                }
            },
        ];
    });


    $scope.opFittingsRebackGoods.subscribe(res => {

        $scope.workedObj = res.body.goods.map(v => ({
            num: v.num,
            fdId: v.fd.id,
            code: v.fd.code,
            name: v.fd.name,
            ft: v.fd.ft,
            fgId: v.id,
            grs: v.fgrs
        }));
    });

    $scope.rtrClick = async (item, index, event) => {
        const res = await $scope.opWorkFittingsOutGoods.getData({ id: item.id });
        $scope.obj = res.body.topic;
        $scope.obj.summary = '';
        $scope.workedObj = res.body.goods.map(v => ({
            num: v.num,
            fdId: v.fd.id,
            code: v.fd.code,
            name: v.fd.name,
            ft: v.fd.ft,
            fgId: v.id,
            grs: []
        }));
        $('#rMyTable tbody tr.tr-click').eq(index).addClass('active').siblings().removeClass('active');
        $scope.$apply();
    };


    $scope.deleteRoom = (fdIndex, grsIndex) => {
        $scope.workedObj[fdIndex].grs.splice(grsIndex, 1);
    };


    $scope.numChange = (fdIndex, grsIndex) => {
        const { num, max } = $scope.workedObj[fdIndex].grs[grsIndex];
        if (num === null) return;
        if (num === void 0) return $scope.workedObj[fdIndex].grs[grsIndex].num = max;
    };


    $scope.opFittingsDictRoomSelectByFD.beforGetData = async (index, fdId) => {

        const { roomList, grs, num } = $scope.workedObj[index];
        if (roomList && (grs.length >= roomList.length)) return toaster.pop('error', '', '超过库房数量');

        $scope.workedObj[index].grs.push({ num: 0, max: num });

        if ($scope.workedObj[index].grs.length !== 1) return;

        const res = await $scope.opFittingsDictRoomSelectByFD.getData({ fdId });
        if (!res) return;
        $scope.workedObj[index].roomList = res.body;
        $scope.$apply();
    };

    $scope.submit = async () => {

        const { obj: { sn, id, summary }, workedObj } = $scope;
        if (!summary) return toaster.pop('error', '', '请填写备注');
        let same = true, beyond = false;
        const goods = workedObj.map(v => {
            const { fdId, fgId, grs, num } = v;
            if (grs.reduce((a, b) => a + b.num, 0) > num) same = false;
            return {
                fdId,
                fgId,
                grs: grs.filter(v => v.roomId).map(xv => {
                    const { num, max, roomId } = xv;
                    if (num > max) beyond = true;
                    return { num, roomId };
                })
            };
        });

        if (beyond || !same) return toaster.pop('error', '', '还库数量超过出库数量');

        const res = await $scope.opFittingsRebackCreate.getData({
            summary, sn, id, goods
        });
        if (res.code !== 0) return toaster.pop('error', '', '还库创建失败');
        toaster.pop('success', '', '还库创建成功');
        $scope.down = false;
        $scope.diffGetData({ pageIndex: 0 });
        $scope.$apply();
    };

});