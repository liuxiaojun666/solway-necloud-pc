ajaxData({
    getLoginUserInfo:{
        name:'loginUserInfo',
        data: {},
        later: true
    },
    getChatList:{
        name: 'noteDetailChatlist',
        data: {},
        later: true,
        onlyLatest: true
        
    },
    getShareTaskDetailList:{
        name:'GETShareTaskDetailList',
        data: {},
        later: true,
        onlyLatest: true
    },
    //事件详情
    eventDetail:{
        name:'POSTeventDetail',
        data:{},
        later:true
    },
    //任务详情
    taskDetail: {
        name: 'POSTtaskDetail',
        data: {},
        later: true
    },
    //事件处理详情
    eventHandleDetail: {
        name: 'POSTeventHandleDetail',
        data: {},
        later: true
    },
},{
    __serviceName__: 'chatPanelService'
})('chatPanelCtrl', ['$scope', 'chatPanelService'], ($scope, myAjaxData) => {

    const resizeHeight = () =>{
        $(".chat-panel-list").height($(window).height() - 230)
    }

    resizeHeight();
    window.addEventListener('resize', resizeHeight);

    //列表接口
    const getChatList = () =>{
        $scope.getChatList.getData({
            busitype: $scope.busitype,
            parentid: $scope.parentid,
            isHis: $scope.isHis,
            pageIndex: 0,
            pageSize: 20
        }).then(res => {
            $scope.chatList = res;
        });
    }

    //接收
    $scope.$on('chatPanelObj', (e, obj) => {
        $scope.chatList = []
        $scope.handle = false;

        $scope.busitype = obj.busitype;
        $scope.parentid = obj.mid;
        $scope.isHis = obj.isHis;
        getChatList();
    });

    //共享处理列表接口
    const getShareList = taskId =>{
        $scope.getShareTaskDetailList.getData({
            taskId: taskId
        }).then(res => {
            $scope.shareList = res.body;
        });
        
    }

    //获取当前用户
    $scope.getLoginUserInfo.getData({
    }).then(res => {
        $scope.userId = res.userId;
    });

    //打开共享处理情况列表
    $scope.shareHandle = (index, busino) =>{
        $scope.handle = !$scope.handle;
        if ($scope.handle){
            $scope.currentIndex = index;
            getShareList(busino);
        }
    }

    //收回处理列表接口
    $scope.hideShareList = () => {
        $scope.currentIndex = '';
        $scope.handle = false;
    }

    //查看详情
    $scope.noteDetails = function (messageId, busitype, busino) {

        $scope.isInspected = false;//是否为验收，普通详情false，验收true

        var interfaceMap = {'00': 'eventDetail', '01': 'taskDetail', '02': 'eventHandleDetail'};
        var currentInterface = interfaceMap[busitype];
        $scope[currentInterface].getData({
            id: busino
        }).then(res => {
            $scope.$broadcast('showChatDetail',{'busitype':busitype,'data':res})
        });

        $('#chatDetail').modal({ backdrop: 'static', keyboard: false });
    }

    

    //记录处理情况
    $scope.recordHandle = index => {
        // $scope.currentIndex = index;
        // $scope.handle = true;
    }

    //发布共享运维任务
    $scope.publishShareTask = index =>{

    }


    $scope.$on('$destroy', () => {
        window.removeEventListener('resize', resizeHeight);
    });

});