ajaxData({
    getLoginUserInfo:{
        name:'loginUserInfo',
        data: {},
        later: true
    },
    getChatList:{
        name: 'noteDetailChatlist',
        data: {},
        later: true,
        onlyLatest: true
        
    },
    getShareTaskDetailList:{
        name:'GETShareTaskDetailList',
        data: {},
        later: true,
        onlyLatest: true
    },
    //事件详情
    eventDetail:{
        name:'POSTeventDetail',
        data:{},
        later:true
    },
    //任务详情
    taskDetail: {
        name: 'POSTtaskDetail',
        data: {},
        later: true
    },
    //事件处理详情
    eventHandleDetail: {
        name: 'POSTeventHandleDetail',
        data: {},
        later: true
    },
    //派人处理
    eventToHandle:{
        name:'POSTpersonHandle',
        data:{},
        later:true
    },
    //不处理
    eventNoHandle:{
        name:'POSTnohandle',
        data:{},
        later:true
    },
    //事件日志
    eventDiary:{
        name: 'POSTeventDiary',
        data: {},
        later: true
    },
    //人员列表
    personList:{
        name:'POSTpersonList',
        data:{},
        later:true
    },
    //指派给他人处理
    otherToHandle:{
        name: 'POSTotherToHandle',
        data: {},
        later: true
    },
},{
    __serviceName__: 'chatPanelService'
})('chatPanelCtrl', ['$scope', 'chatPanelService'], ($scope, myAjaxData) => {

    const resizeHeight = () =>{
        $(".chat-panel-list").height($(window).height() - 230)
    }

    resizeHeight();
    window.addEventListener('resize', resizeHeight);

    //列表接口
    const getChatList = () =>{
        $scope.getChatList.getData({
            busitype: $scope.busitype,
            parentid: $scope.parentid,
            isHis: $scope.isHis,
            pageIndex: 0,
            pageSize: 20
        }).then(res => {
            $scope.chatList = res;
        });
    }

    //接收
    $scope.$on('chatPanelObj', (e, obj) => {
        $scope.chatList = []
        $scope.handle = false;

        $scope.busitype = obj.busitype;
        $scope.parentid = obj.mid;
        $scope.isHis = obj.isHis;
        getChatList();
    });

    //重新获取列表
    $scope.$on('initChatList',(e,v)=>{
        getChatList();
    })

    //共享处理列表接口
    const getShareList = taskId =>{
        $scope.getShareTaskDetailList.getData({
            taskId: taskId
        }).then(res => {
            $scope.shareList = res.body;
        });
        
    }

    //获取当前用户
    $scope.getLoginUserInfo.getData({
    }).then(res => {
        $scope.userId = res.userId;
    });

    //打开共享处理情况列表
    $scope.shareHandle = (index, busino) =>{
        $scope.handle = !$scope.handle;
        if ($scope.handle){
            $scope.currentIndex = index;
            getShareList(busino);
        }
    }

    //收回处理列表接口
    $scope.hideShareList = () => {
        $scope.currentIndex = '';
        $scope.handle = false;
    }

    //获取人员列表
    $scope.getUserList = function (busino) {
        $scope.managerd01 = {};
        $scope.eventDiary.getData({
            id: busino
        }).then(res => {
            $scope.pstationId = res.pstationid;
            $scope.personList.getData({
                sid: $scope.pstationId
            }).then(result => {
                $scope.manager01 = result;
                $scope.managerd01.selected = { realName: $scope.manager01[0].realName, userId: $scope.manager01[0].userId };
                $scope.respman = $scope.managerd01.selected.userId;

            });
        });
    }

    //查看详情
    $scope.noteDetails = function (messageId, busitype, busino) {
        $scope.isInspected = false;//是否为验收，普通详情false，验收true
        var interfaceMap = {'00': 'eventDetail', '01': 'taskDetail', '02': 'eventHandleDetail'};
        var currentInterface = interfaceMap[busitype];
        $scope[currentInterface].getData({
            id: busino
        }).then(res => {
            $scope.$broadcast('showChatDetail',{'busitype':busitype,'data':res})
        });

        $('#chatDetail').modal({ backdrop: 'static', keyboard: false });
    }

    //确认---》处理（派给他人、自己、不处理）
    $scope.toHandle = (who,id) =>{
        
        $scope.$broadcast('showEventHandle',{'who':who,'id':id})

        $('#toHandleModal').modal({ backdrop: 'static', keyboard: false });
    }  


    //记录处理情况
    $scope.recordHandle = index => {
        // $scope.currentIndex = index;
        // $scope.handle = true;
    }

    //发布共享运维任务
    $scope.publishShareTask = index =>{

    }


    $scope.$on('$destroy', () => {
        window.removeEventListener('resize', resizeHeight);
    });

});