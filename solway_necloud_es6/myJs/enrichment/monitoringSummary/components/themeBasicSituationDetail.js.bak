ajaxData({
    // 电站 日 月 年 
    stationData: {
        name: 'GETpvMonitorGetRunBaseList',
        data: {},
        later: true,
        onlyLatest: true
    },
    // 公司今日
    companyData: {
        name: 'GETBaseSituationCompanyData',
        data: {},
        later: true,
        onlyLatest: true
    },
}, {
        __serviceName__: 'themeBasicSituationDetailService'
    })('themeBasicSituationDetailCtrl', ['$scope', 'themeBasicSituationDetailService', 'historicalRecord'], ($scope, myAjaxData, historicalRecord) => {
        // 初始化 scope
        $scope.initChildScope($scope, myAjaxData);

        // 主页面初始化完成 回调
        $scope.mainPageInitComplete = async () => {
            let { showShape } = historicalRecord.get().themeBasicSituationData || {};
            await $scope.dateUpdated();
            $scope.changeShowShape(showShape || 'list');
            const { dateType, dateTime } = historicalRecord.get();
            $scope.dateType = dateType;
            $scope.dateTime = dateTime;
            $('.ng-clock').removeClass('ng-clock');
            $scope.initComplete = true;
            await myAjaxData.timeout(0);
            diffGetData();
            $scope.$apply();
        };

        // 切换电站 回调
        $scope.switchPowerCallback = () => {
            $scope.stationData.res = null;
            $scope.companyData.res = null;
            diffGetData();
        };

        // 日期改变
        $scope.dateUpdated = async() => {
            await myAjaxData.timeout(0);
            diffData();
            diffGetData();
        };

        // 切换显示形式  图表 or 列表
        $scope.changeShowShape = showShape => {
            if (showShape === $scope.showShape) return;
            $scope.showShape = showShape;
            historicalRecord.set({
                themeBasicSituationData: {
                    ...historicalRecord.get().themeBasicSituationData || {},
                    showShape
                }
            });
        };


        async function diffGetData() {
            if (!$scope.initComplete) return;
            await myAjaxData.timeout(0);
            const { currentClass, showShape, dateTime, dataType, dateType } = $scope;
            // 电站接口
            if (dataType === 0) {
                if ($scope.stationData.res) return;
                $scope.stationData.getData({
                    queryType: 3,
                    dateType: [3, 2, 1][dateType],
                    date: dateTime.showDate
                });
            } else if (dataType > 0) {
                if ($scope.companyData.res) return;
                $scope.companyData.getData({
                    queryType: 1,
                    dateType: [3, 2, 1][dateType],
                    date: dateTime.showDate
                });
            }
        }

        // 公司 历史日 数据 处理
        $scope.companyData.getDataCallback = (success, res) => {
            if (!success) return;
            $scope.datasource = res.body.resultList;
            $scope.ydatas = [[res.body.resultList.map(v => v.buildcapacity)]];
            $scope.xdata = res.body.resultList.map(v => v.stationname);
            $scope.column = [
                {
                    title: '电站名称',
                    dataIndex: 'stationname',
                    sort: 'true',
                    align: 'left'
                }, {
                    title: '装机容量kW',
                    dataIndex: 'buildcapacity',
                    sort: 'true',
                    align: 'right'
                }, {
                    title: '投产时间',
                    dataIndex: 'productiondate',
                    sort: 'true',
                    align: 'center',
                    render(text) {
                        // const dateStr = new Date(text).Format('yyyy-MM-dd');
                        return `<span>${new Date(text).Format('yyyy-MM-dd')}</span>`
                    }
                }, {
                    title: '接入时间',
                    dataIndex: 'expiryDate',
                    sort: 'true',
                    align: 'center',
                    render(text) {
                        return `<span>${text || ''}</span>`
                    }
                }, {
                    title: '地址',
                    dataIndex: 'address',
                    align: 'left'
                }
            ];
        };

        // 定位
        $scope.showPosition = function () {
            if (!$scope.stationData.res) return;
            if (document.getElementById('allmap').innerHTML === '') {
                const map = $scope.map = new BMap.Map("allmap");
                map.enableScrollWheelZoom();   //启用滚轮放大缩小
                map.enableContinuousZoom();    //启用地图惯性拖拽
            }
            const {map} = $scope;
            map.clearOverlays();
            const point = new BMap.Point(parseFloat($scope.stationData.res.body.resultList.longitude) - 0.03083, parseFloat($scope.stationData.res.body.resultList.latitude) + 0.01553);
            map.centerAndZoom(point, 15);
            const point2 = new BMap.Point($scope.stationData.res.body.resultList.longitude, $scope.stationData.res.body.resultList.latitude);
            const marker = new BMap.Marker(point2); // 创建标注
            map.addOverlay(marker); // 将标注添加到地图中
            marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
        };

        // 公司 数据 投产 时间 对比
        function diffData() {
            if (!$scope.initComplete) return;
            if ($scope.dataType === 0) return;
            if (!$scope.companyData.res) return;
            const {dateType, dateTime} = $scope;
            $scope.barColors = $scope.companyData.res.body.resultList.map(v => {
                if (dateType === 0 && dateTime.showDate === new Date(v.productiondate).Format('yyyy-MM-dd')) return 'rgb(255,0,0)';
                if (dateType === 1 && dateTime.showDate.substr(0, 7) === new Date(v.productiondate).Format('yyyy-MM')) return 'rgb(255,0,0)';
                if (dateType === 2 && dateTime.showDate.substr(0, 4) === new Date(v.productiondate).Format('yyyy')) return 'rgb(255,0,0)';
            });
        }

    });