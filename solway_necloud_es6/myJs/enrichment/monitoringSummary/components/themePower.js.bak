ajaxData({
    //当日
    currentPowerInfo: {
        name: 'GETPowerCurrentInfo',
        later: true
    },
    //历史日
    query_station_day_kw_subject_his:{
        name:'GETquery_station_day_kw_subject_his',
        later:true
    }
}, {
    __serviceName__: 'themePowerAjaxData'
    })('themePowerCtrl', ['$scope', 'themePowerAjaxData', '$timeout', '$interval'], ($scope, myAjaxData, $timeout, $interval) => {

    $scope.initChildScope($scope, myAjaxData);

    let myChart = echarts.init(document.getElementById('themePowerGaugeEchart'))
    
    const initEchart = (currentPower) => {
        const option = {
            tooltip: {
                formatter: "{a} <br/>{b}  {c}%"
            },
            toolbox: {
                show: false,
                feature: {
                    restore: {},
                    saveAsImage: {}
                }
            },
            series: [
                {
                    name: '出力比',
                    type: 'gauge',
                    radius: '100%',
                    // max:maxValue,
                    splitLine: {
                        length: 10
                    },
                    axisLine: {            // 坐标轴线
                        lineStyle: {       // 属性lineStyle控制线条样式
                            color: [[1, 'rgba(26,174,151,0.2)']],
                            width: 30,
                            shadowColor: '#fff', //默认透明
                            shadowBlur: 12
                        }
                    },
                    axisTick: {
                        lineStyle: {
                            color: '#76a8d9'
                        }
                    },
                    axisLabel: {
                        color: 'white',
                        distance: 2
                    },
                    pointer: {
                        width: 5,
                        length: '100%'
                    },
                    itemStyle: {
                        //color:'#5086c0'
                        color: 'red',
                        borderWidth: 10,
                        borderColor: 'pink'
                    },
                    detail: { formatter: '{value}%', show: false },
                    data: [{ value: currentPower, name: '' }]
                }
            ]
        };
        myChart.setOption(option)
        myChart.resize();
    }

    const initParams = async() => {
        if ($scope.detailFullPage) {
            return false;
        } else {
            if ($scope.getTopXhr === false) return false; 

            const queryType = $scope.dataType ? 1 : 3 //集团1，电站3
            const dateType = ($scope._dateType == 0) ? 3 : ($scope._dateType == 1 ? 2 : 1);
            const dateTime = $scope._dateTime.showDate;

            await myAjaxData.timeout(0)
            $("#themePowerGaugeEchart").width($("#themePower").width());
            
            $scope.getAjaxData(queryType, dateTime, dateType)
        }
    }

    //父页面初始化完成
    $scope.mainPageInitComplete = () => {
        initParams();
    };

    //切换日期类型
    $scope.dateUpdated = () => {
        initParams();
    }

    //切换电站
    $scope.switchPowerCallback = () => {
        initParams();
    }

    //点击放大后
    $scope.switchDetailFullPage = () => {
        initParams();
    }
    
    //接口
    $scope.getAjaxData = (queryType, dateTime, dateType) => {
        $scope.themePowerIsLoding = !$scope.currentPowerInfo.res;
        if ($scope.currentClass == 'StationDayToday' || $scope.currentClass == 'CompanyDayToday'){
            $scope.currentPowerInfo.getData({
                'queryType': queryType,
                'date': dateTime,
                'dateType': dateType
            }).then(res => {
                $scope.themePowerIsLoding = false;
                if (res.code == 0) {
                    $scope.data = res.body;
                    initEchart(res.body.kw_r[0]);
                }else{
                    $scope.data = {};
                    initEchart('');
                }
                $scope.$emit('lastUpdate', { comm: res.body.comm, dtime: res.body.dtime})
            })
        } else if ($scope.currentClass == 'StationDayAgo' || $scope.currentClass == 'CompanyDayAgo'){
            $scope.query_station_day_kw_subject_his.getData({
                'queryCode': 'query_station_day_kw_subject_his',
                'queryType': queryType,
                'date': dateTime
            }).then(res => {
                $scope.themePowerIsLoding = false;
                if (res.code == 0) {
                    $scope.data = res.body;
                    initEchart(res.body.max_p_rate[0]);
                }else{
                    $scope.data = {};
                    initEchart('');
                }
            })
        }
    }

    const interval = $interval(() => {
        if ($scope.currentClass === 'StationDayToday' || $scope.currentClass === 'CompanyDayToday') initParams();
    }, 10000);

    window.addEventListener("resize", () => {
        $("#themePowerGaugeEchart").width($("#themePower").width())
        myChart.resize();
    });

    $scope.$on('$destroy', () => {
        myChart = null;
        $interval.cancel(interval);
    });
});