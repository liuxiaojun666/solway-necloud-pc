ajaxData({
    //集团、电站---------当日
    electricityCurrent:{
        name: 'GETElectricityCurrent',
        later: true
    },
    //电站---------历史日
    query_station_day_elec_subject_his: {
        name: 'GETquery_station_day_elec_subject_his',
        later: true
    },
    //电站---------月
    query_station_month_elec_subject_his: {
        name: 'GETquery_station_month_elec_subject_his',
        later: true
    },
    //电站---------年
    query_station_year_elec_subject_his: {
        name: 'GETquery_station_year_elec_subject_his',
        later: true
    },
    //集团---------历史日
    query_company_day_elec_subject_his: {
        name: 'GETquery_company_day_elec_subject_his',
        later: true
    },
    //集团---------月
    query_company_month_elec_subject_his: {
        name: 'GETquery_company_month_elec_subject_his',
        later: true
    },
    //集团---------年
    query_company_year_elec_subject_his: {
        name: 'GETquery_company_year_elec_subject_his',
        later: true
    }
}, {
    __serviceName__: 'themeElectricityAjaxData'
})('themeElectricityCtrl', ['$scope', 'themeElectricityAjaxData', '$timeout'], ($scope, myAjaxData, $timeout) => {

    $scope.initChildScope($scope, myAjaxData);
    
    const pieChart = echarts.init(document.getElementById('themeElePieEchart'));
    const pieChartSmall = echarts.init(document.getElementById('themeElePieEchartSmall'));

    const initPieEchart = () => {
        let pieId;
        if ($scope.currentClass == 'StationMonth' || $scope.currentClass == 'StationYear' || $scope.currentClass == 'CompanyMonth' || $scope.currentClass == 'CompanyYear') {
            pieId = pieChartSmall;//小Pie
        } else if ($scope.currentClass == 'StationDayAgo' || $scope.currentClass == 'CompanyDayAgo') {
            pieId = pieChart;     //大Pie       
        }
        const option = {
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b} : {c} ({d}%)"
            },
            series: [
                {
                    name: '半径模式',
                    type: 'pie',
                    radius: ['20%', '80%'],
                    center: ['50%', '40%'],
                    roseType: 'radius',
                    label: {
                        normal: {
                            show: false
                        },
                        emphasis: {
                            show: true
                        }
                    },
                    lableLine: {
                        normal: {
                            show: false
                        },
                        emphasis: {
                            show: true
                        }
                    },
                    data: [
                        {
                            value: 12, name: '限电',
                            itemStyle: {
                                normal: {
                                    color: '#40a5dd'
                                }
                            }
                        },
                        {
                            value: 18, name: '其他',
                            itemStyle: {
                                normal: {
                                    color: '#847ce9'
                                }
                            }
                        },
                        {
                            value: 15, name: '故障',
                            itemStyle: {
                                normal: {
                                    color: '#fa7594'
                                }
                            }
                        }

                    ]
                }
            ]
        };
        pieId.setOption(option);
        pieId.resize();
    }

    const initEchartHeightWidth = () =>{
        //左侧柱状图占的比例
        if ($scope.currentClass == 'StationMonth' || $scope.currentClass == 'StationYear' || $scope.currentClass == 'CompanyMonth' || $scope.currentClass == 'CompanyYear') {
            $scope.whichPart = 'part1-3';
            $scope.barWidth = $("#themeElectricity").width() * 0.56;
            $("#themeElePieEchartSmall").width($("#themeElectricity").width() * 0.44 * 0.5)

            $scope.xAxis = ['实发电量', '上网电量', '计划发电量', '预测发电量', '应发电量'];
        } else if ($scope.currentClass == 'StationDayAgo' || $scope.currentClass == 'CompanyDayAgo') {
            $scope.whichPart = 'part1-2';
            $scope.barWidth = $("#themeElectricity").width() * 0.7;
            $("#themeElePieEchart").width($("#themeElectricity").width() * 0.3)

            $scope.xAxis = ['实发电量', '上网电量', '预测发电量', '应发电量'];
        } else {
            $scope.whichPart = 'part1-1';
            $scope.barWidth = $("#themeElectricity").width();

            $scope.xAxis = ['实发电量', '上网电量', '当日预测发电量', '明日预测发电量', '后日预测发电量'];
        }

        // $scope.$apply();
    }

    const initParams = async () => {
        if ($scope.detailFullPage) return false; //放大状态，不做处理

        const queryType = $scope.dataType ? 1 : 3 //集团1，电站3
        const dateType = ($scope._dateType == 0) ? 3 : ($scope._dateType == 1 ? 2 : 1);
        const dateTime = $scope._dateTime.showDate;

        await myAjaxData.timeout(0)

        initEchartHeightWidth();

        $scope.getAjaxData(queryType, dateTime, dateType)
    }

    //父页面初始化完成
    $scope.mainPageInitComplete = () => {
        initParams();
    };

    //切换日期类型
    $scope.dateUpdated = () => {
        initParams();
    }

    //切换电站
    $scope.switchPowerCallback = () => {
        initParams();
    }

    //点击放大后
    $scope.switchDetailFullPage = () => {
        initParams();
    }

    //接口
    $scope.getAjaxData = (queryType, dateTime, dateType) => {
        $scope.themePowerIsLoding = true;
        if ($scope.currentClass == 'StationDayToday' || $scope.currentClass == 'CompanyDayToday') {
            $scope.electricityCurrent.getData({
                'queryType': queryType,
                'date': dateTime,
                'dateType': dateType
            }).then(res => {
                console.log(res);
                $scope.themePowerIsLoding = false;
                if (res.code == 0) {
                    $scope.data = res.body;
                    $scope.yAxis = [200, 400, 145, 300, 200];
                }
            })
        } else {
            let params='';
            switch ($scope.currentClass) {
                case 'StationDayAgo':
                    params = 'query_station_day_elec_subject_his'
                    break;
                case 'StationMonth':
                    params = 'query_station_month_elec_subject_his'
                    break;
                case 'StationYear':
                    params = 'query_station_year_elec_subject_his'
                    break;
                case 'CompanyDayAgo':
                    params = 'query_company_day_elec_subject_his'
                    break;
                case 'CompanyMonth':
                    params = 'query_company_month_elec_subject_his'
                    break;
                case 'CompanyYear':
                    params = 'query_company_year_elec_subject_his'
                    break;
                default:
                    break;
            }
            $scope.getHistoryData(params, queryType, dateTime)
        }
    }

    //历史接口
    $scope.getHistoryData = (params, queryType, dateTime) =>{
        $scope[params].getData({
            'queryCode': params,
            'queryType': queryType,
            'date': dateTime
        }).then(res => {
            $scope.themePowerIsLoding = false;
            console.log(res)
            if (res.code == 0) {
                $scope.data = res.body;
                // debugger
                initPieEchart();
            }
        })
    }

    window.addEventListener("resize", function () {
        // initEchartHeightWidth();
    });

});