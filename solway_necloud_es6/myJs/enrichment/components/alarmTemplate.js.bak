app.directive('alarmTemplate', ['$ocLazyLoad', '$http', '$state', '$timeout','$rootScope', ($ocLazyLoad, $http, $state, $timeout,$rootScope) => ({
    restrict: 'E',
    transclude: !0,
    replace: !0,
    scope: {

    },
    templateUrl: 'tpl/enrichment/components/alarmTemplate.html',
    link($scope, $element) {

        //报警状态
        $scope.currentStatus = 'normal'; //abnormal,normal

        const newUtterance = new SpeechSynthesisUtterance();

        const judgeIfAlarm = () =>{
            if($scope.currentStatus == 'abnormal'){
                $scope.alarmListPageShow = false;
                if($scope.total_sure_no) $scope.ifTwinkle = true;
            }else{
                $scope.alarmListPageShow = true;
                $scope.ifTwinkle = false;
            }
        }
        
        //设置列表高度
        const calculateListHeight = () =>{
            $scope.winHeight = $(window).height();
            $(".alarm-list").height($scope.winHeight-68);
        }
    
        calculateListHeight();
        window.addEventListener('resize', calculateListHeight);

        document.onkeydown=function(event){ 
            var e = event || window.event || arguments.callee.caller.arguments[0];               
            if (e.keyCode == 65 ) { 
                newUtterance.text = $scope.voiceContent;
                window.speechSynthesis.speak(newUtterance);
            }
        };  
         //语音
        // function speak(textToSpeak) {
        //     let newUtterance = new SpeechSynthesisUtterance();
        //     newUtterance.text = textToSpeak;
        //     window.speechSynthesis.speak(newUtterance);
            
        // }

        // speak();

        // $timeout(()=>{
        //     speak('中华人民共和国哈哈哈 the People\'s Republic of China;');
        // },0)

        //下拉或者收缩
        $scope.toggleAlarmList = () =>{
            $scope.alarmListPageShow = !$scope.alarmListPageShow;
            if ($scope.alarmListPageShow) {
                $scope.ifTwinkle = false;
                $(".alarm-list").slideDown();
            } else {
                $scope.ifTwinkle = true;
                $(".alarm-list").slideUp();
            }
        }

        //批量标记为已确认
        $scope.toConfirm = () =>{
            const checkedIds = [];
            $("input[name='alarmCheckedName']:checked").map((index,v)=>{
                checkedIds.push(v.dataset.ids)
            })

        }

        $scope.trClick = (item, index, e) => {
            $scope.voiceContent = item.voiceContent;
            // e.stopPropagation();
            
            //$scope.$apply();
        };
        
        $scope.initData = () =>{
            const checkedCondition = [];
          
            $("input[name='conditionType']:checked").map((index,v)=>{
                checkedCondition.push(v.dataset.status)
            })

            $http({
                method: "GET",
                url: window.baseUrl + "/pv/alarm/getRunAlarmList.htm",
                params: {
                    startId:0
                }
            }).success(function (res) {
                if(res.code == 0){
                    const alarmList = res.body.alarmList;
                    const alarmInfo = res.body.alarmTotalInfo;
                    $scope.total = alarmInfo.total;
                    $scope.total_sure_no = alarmInfo.total_sure_no;
                    $scope.total_sure_yes = alarmInfo.total_sure_yes;

                    if($scope.total) $scope.currentStatus = 'abnormal';
                    if(alarmList.length) $scope.datalist = alarmList;

                    judgeIfAlarm();
                }else{
                    alert(res.msg);
                }
            });

            //测试
            // $scope.datalist = [{"stid":3002,"stname":"马鞍山蒙牛1"},{"stid":3003,"stname":"马鞍山蒙牛2"},{"stid":3004,"stname":"马鞍山蒙牛3"}]
            $scope.column = [
                {
                    title: '<label class="i-checks m-b-none"><input type="checkbox"><i style="background:transparent;"></i></label>',
                    dataIndex: '',
                    width: '60px',
                    align: 'center',
                    checkboxName: 'alarmCheckedName',
                    render(text, record, index) {
                        return '<label class="i-checks m-b-none"><input data-ids="' + record.stid + '" name="alarmCheckedName" type="checkbox" /><i style="background:transparent;"></i></label>';
                    }
                },
                {
                    title: '电站名称',
                    dataIndex: 'pstationname',
                    width: '20%',
                },
                {
                    title: '设备名称',
                    dataIndex: 'devicename',
                    width: '20%',
                },
                {
                    title: '故障类型',
                    dataIndex: 'faultclassStr',
                },
                {
                    title: '发生时间',
                    dataIndex: 'sStartTime',
                },
                {
                    title: '事件描述',
                    dataIndex: 'eventDesc',
                },
                {
                    title: '确认时间',
                    dataIndex: '',
                },
                {
                    title: '确认',
                    dataIndex: 'handstatusStr',
                }
            ];

        }

        $scope.initData();
        

        $scope.$on('$destroy', () => {
            window.removeEventListener('resize', calculateListHeight);
        });
    }
})])
