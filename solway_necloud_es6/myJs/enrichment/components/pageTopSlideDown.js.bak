app.directive('pageSlideDown', ['$ocLazyLoad', '$http', '$state','$stateParams', '$timeout','$rootScope','actionRecord',($ocLazyLoad, $http, $state, $stateParams,$timeout,$rootScope,historicalRecord) => ({
    restrict: 'E',
    transclude: !0,
    replace: !0,
    scope: {

    },
    templateUrl: 'tpl/enrichment/components/pageSlideDown.html'+window.stamp,
    link($scope, $element) {

        $scope.goChildrenPage = (routerUrl,theme) => {
            $solway.setStore('systemInfo', {'systemTab':$scope.systemTab,'module':[routerUrl,theme]}); 
            if($scope.currentState == routerUrl){
                $(".systems-page").slideUp();
                return false;
            }
            if ($scope.currentState == 'power-index171024') {
                $http({
                    method: "POST",
                    url: window.baseUrl + "/UserAuthHandle/setSTClass.htm",
                    params: {
                    }
                }).success(function (res) {
                    $state.go(routerUrl);
                });
            } else {
                $state.go(routerUrl);
            }
        }

        $scope.goBoughtModulePage = (routerUrl,theme) =>{
            $solway.setStore('systemInfo', {'systemTab':$scope.systemTab,'module':[routerUrl,theme]}); 
            if(routerUrl == theme){
                const falsify = historicalRecord.falsify(routerUrl,{},true);
                if(falsify.redirect == 'failure'){
                    $(".systems-page").slideUp();
                }
            }else{
                const falsify = historicalRecord.falsify(routerUrl,{'theme':theme},true);
                // debugger
                if(falsify.redirect == 'failure'){
                    $scope.currentFun = theme;
                    $scope.$parent.reloadParentPage({});
                    $(".systems-page").slideUp();
                }
            }
        }


        //到不同首页
        $scope.goMainPage = () =>{
            $state.go($rootScope.mainPageUrl);
        }

        //切换不同体系
        $scope.changeSystemTab = type =>{
            $scope.systemTab = type;
            const record = $solway.getStore().systemInfo;
            // $scope.currentState = record.module?record.module[0]:'';
            $scope.currentState = $state.current.name;
            $scope.currentFun = record.module?record.module[1]:'';
        }

        //鼠标悬浮0.5s页面头部，出现下拉页面
        let timer = null;
        const setMainHeight = () => {
            let wHeight = $(window).height();
            let muduleHeight = 500;
            $(".module-list").css('marginTop', (wHeight - muduleHeight)/2)
            $(".function-list").css('marginTop', (wHeight - 660)/2)
        }

        setMainHeight()

        window.addEventListener('resize', setMainHeight);
        $scope.$on('$destroy', () => {
            window.removeEventListener('resize', setMainHeight);
        });

        $timeout(() => {
            $('body').on('mouseover','.hover-header-con',()=>{
                timer = setTimeout(() => {
                    $(".systems-page").slideDown();
                }, 500);
            })
            $('body').on('mouseout', '.hover-header-con', () => {
                if (timer) clearTimeout(timer);
            })
        }, 0)

        $('body').on('click', '.hover-header-con-click', () => {
            $(".systems-page").slideDown();
        })

        $(".close_btn_slide").click(() => {
            $(".systems-page").slideUp();
        });

        $(".square-common").hover(function () {
            $(this).addClass('active');
        }, function () {
            if($(this).hasClass($scope.currentState)) return;
            $(this).removeClass('active');
        })


    },
    controller($scope, $element){
        historicalRecord.init();
        
        $scope.stamp = window.stamp;

        historyInitCallback();

        // 获取记录
        function historyInitCallback() {
            const record = $solway.getStore().systemInfo;
            const {systemTab = 'concept'} = record;
            $scope.systemTab = systemTab;

            $scope.currentState = $state.current.name;
            // $scope.currentState = record.module?record.module[0]:'';
            $scope.currentFun = record.module?record.module[1]:'';
        };
    }
})])
