app.directive('personalCenter', ['myAjaxData', '$timeout', '$http', '$interval', (myAjaxData, $timeout, $http, $interval) => ({
    restrict: 'E',
    replace: !0,
    scope: {
        
    },
    templateUrl: window.baseUrl + '/tpl/enrichment/components/personalCenter.html',
    link($scope) {
        
    },
    controller($scope) {
        //获取角色
        $http({
            method: "POST",
            url: window.baseUrl +"/UserAuthHandle/getRoleListForPC.htm"
        }).success(function (res) {
            $scope.rolelist = res.rolelist;	//用户列表
            $scope.currentRoleID = res.currentRole;//当前用户的ID‘
            $scope.roleType = res.roleType;//当前角色类型
            const currentRoleNum = getArrAtrNum($scope.rolelist, 'roleId', $scope.currentRoleID);
            $scope.currentRoleName = $scope.rolelist[currentRoleNum].roleDisplayName;//当前角色名
        });

        //获取当前用户
        $http.get(window.baseUrl +"/Login/getLoginUser.htm", {
            timeout: 5000
        }).success(function (result) {
            $scope.loginName = result.userName;
            $scope.userId = result.userId;
            
        })

        var intervalInvites = $interval(function() {
            getInvitesNum();
        },60000)

        getInvitesNum();

        //获取邀请消息条数
        function getInvitesNum() {
            $http({
                method: "POST",
                url: window.baseUrl + "/BaseMessage/queryCompanyInviteCount.htm"
            }).success(function (res) {
                if(res.code == 1 && res.data>0){
                    $scope.ifInviteNote = true;
                }else{
                    $scope.ifInviteNote = false;
                }
            });
        }

        //接受or 拒绝后，列表为空，图标显示变化
        $scope.$on('noInviteNote',function(e,v) {
            $scope.ifInviteNote = false;            
        });

        //打开邀请消息弹框
        $scope.showInviteListModel = function(params) {
            $('#invitePersonNoteModel').modal('show');
            $scope.$broadcast('invitePersonNote', true);
        }
        //电站组
        $scope.powerStationManage = function () {
            $('#powerStationManageModal').modal('show');
        }

        //个人信息
        $scope.editUserData = function () {
            initPageDataUserMod($scope.userId);
            $('#userInformationUpdateModel').modal('show');
        }

        //修改密码
        $scope.changePassword = function () {
            $('#userPasswordChangeModel').modal('show');
        }

        //退出登录
        $scope.logOut = () =>{
            $.ajax({
                type: "post",
                url: window.baseUrl +"/Login/logout.htm",
                timeout: 5000,
                data: {},
                success: function (msg) {
                    window.location.href = window.baseUrl+"/login.jsp";
                },
                error: function (msg) {
                    window.location.href = window.baseUrl +"/login.jsp";
                }
            });
        }

        $scope.$on('$destroy', () => {
            $interval.cancel(intervalInvites);
        });

        //根据数组中每项的每个属性的值查找在数组中的排序，找不到返回-1
        function getArrAtrNum(arr, atr, value) {//getArrAtrNum([{id:1},{id:2}], "id", 3)
            for (var i = 0; i < arr.length; i++) {
                if (arr[i][atr] == value) {
                    return i;
                }
            }
            return -1;
        };
    }
})]);