ajaxData(
    {
        rtmSingleStationComm: {
            name: 'GETRtmSingleStationComm',
            data: {
                dateString: new Date().Format("yyyy-MM-dd"),
            },
            later: true,
            onlyLatest: true,
            sameTimeOnce: true
        },
        deviceInfo: {
            name: 'GETdeviceInfo',
            data: {},
            later: true
        }
    },
    {
        __serviceName__: 'equipmentPopUpService',
        depend: [
            'theme/js/dist/enrichment/components/equipmentPopUp/bigInverter.js' + stamp, 
            'theme/js/dist/enrichment/components/equipmentPopUp/junctionBox.js' + stamp, 
            'theme/js/dist/enrichment/components/equipmentPopUp/smallInverter.js' + stamp, 
            'theme/js/dist/enrichment/components/equipmentPopUp/boxChange.js' + stamp
        ],
        templateUrl: [
            'tpl/enrichment/components/equipmentPopUp/bigInverter.html' + stamp,
            'tpl/enrichment/components/equipmentPopUp/junctionBox.html' + stamp,
            'tpl/enrichment/components/equipmentPopUp/smallInverter.html' + stamp,
            'tpl/enrichment/components/equipmentPopUp/boxChange.html' + stamp
        ]
    }
)('equipmentPopUpCtrl', ['$scope', 'equipmentPopUpService', '$ocLazyLoad', '$interval'], function ($scope, currentService, $ocLazyLoad, $interval) {
    $scope.display = false;
    $scope.$on('equipmentPopUp', async(e, eqObj) => {
        if (!eqObj.deviceSerialNnumber && eqObj.stid && eqObj.eqid) {
            const {stid, eqid} = eqObj;
            const { hasJB, stid: pstationid, id: deviceId, sn: deviceSerialNnumber, type: deviceTypeNow} = await deviceInfo.getData({stid, eqid}).body;
            eqObj.deviceSerialNnumber = deviceSerialNnumber;
            eqObj.hasJB = hasJB;
            eqObj.pstationid = pstationid;
            eqObj.deviceId = deviceId;
            eqObj.deviceTypeNow = deviceTypeNow;
        }
        currentService.config.eqObj = eqObj;
        $scope.templateLoading = true;
        $scope.display = true;
        $scope.templateUrl = '';
        const dataIndex = eqObj.hasJB === '0' ? 0 : eqObj.deviceTypeNow;
        $ocLazyLoad.load([
            'theme/js/dist/components/calendar.js' + stamp,
            'theme/js/dist/components/myTable.js' + stamp,
            'theme/js/dist/components/myPagin.js' + stamp,
        ].concat(currentService.config.depend[dataIndex])).then(() => {
            $scope.templateUrl = currentService.config.templateUrl[dataIndex];
        });
        $scope.rtmSingleStationComm.getData({
            dateString: new Date().Format("yyyy-MM-dd"),
            stids: eqObj.pstationid
        });
    });

    const timer = $interval(() => $scope.rtmSingleStationComm.getData({}), 5 * 1000);

    $scope.includePageDesdroy = () => {
        $scope.display = false; 
        $scope.templateUrl = '';
        $interval.cancel(timer);
        $scope.$broadcast('includePageDesdroy');
    }
});