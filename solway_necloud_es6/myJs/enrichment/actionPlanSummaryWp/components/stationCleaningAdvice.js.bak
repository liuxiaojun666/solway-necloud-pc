ajaxData(
    {
        // 风向标
        wp_station_vane_month_deviceline: {
            name: 'GETwp_station_vane_month_deviceline',
            data: {},
            later: true
        },
        // 风速计
        wp_station_wsm_month_abnormalrateline: {
            name: 'GETwp_station_wsm_month_abnormalrateline',
            data: {},
            later: true
        },
        // 齿轮箱
        wp_station_gearbox_month_oilline: {
            name: 'GETwp_station_gearbox_month_oilline',
            data: {},
            later: true
        },
    },
    {
        __serviceName__: 'actionPlanSummaryStationCleaningAdviceService',
    }
)('actionPlanSummaryStationCleaningAdviceCtrl', ['$scope', 'actionPlanSummaryStationCleaningAdviceService', 'actionRecord'], ($scope, myAjaxData, historicalRecord) => {
    $scope.tablePlaceholder = '<img style="margin: 15px 0;" src="theme/images/enrichment/notFound.png" alt="未发现异常设备插画"/>'

    /// 初始化 scope
    $scope.initChildScope($scope, myAjaxData);

    // 主页面初始化完成 回调
    $scope.mainPageInitComplete = async () => {
        let { tabIndex = 0 } = historicalRecord.get().actionPlanSummaryStationCleaningAdvice || {};
        // if (!cost) {
        //     await $scope.stationCleanCost.getData({});
        //     cost = $scope.stationCleanCost.res.body.totalCost
        //     price = $scope.stationCleanCost.res.body.price || 1
        // }
        // $scope.price = price;
        // $scope.cost = cost;
        $scope.changeTab(tabIndex);
        $('.ng-clock').removeClass('ng-clock');
        $scope.initComplete = true;
        await myAjaxData.timeout(0);
        await $scope.diffGetData();
        $scope.$apply();
    };


    // 切换电站 回调
    $scope.switchPowerCallback = () => {
        if ($scope.dataType !== 0) return;
        $scope.diffGetData();
    };

    // tab 切换
    $scope.changeTab = tabIndex => {
        $scope.tabIndex = tabIndex;
        historicalRecord.set({
            actionPlanSummaryStationCleaningAdvice: {
                ...historicalRecord.get().actionPlanSummaryStationCleaningAdvice || {},
                tabIndex
            }
        });
        $scope.diffGetData();
    };

    // 接口请求
    $scope.diffGetData = async () => {
        if (!$scope.initComplete) return;
        await myAjaxData.timeout(0);
        setDataNull();
        const { tabIndex, dataType } = $scope;
        if (dataType !== 0) return;
        if (tabIndex === 0) {
            $scope.wp_station_vane_month_deviceline.getData({
                queryCode: 'wp_station_vane_month_deviceline',
                queryType: 3,
                date: (new Date).Format('yyyy-MM')
            });
        } else if (tabIndex === 1) {
            $scope.wp_station_wsm_month_abnormalrateline.getData({
                queryCode: 'wp_station_wsm_month_abnormalrateline',
                queryType: 3,
                date: (new Date).Format('yyyy-MM')
            });
        } else if (tabIndex === 2) {
            $scope.wp_station_gearbox_month_oilline.getData({
                queryCode: 'wp_station_gearbox_month_oilline',
                queryType: 3,
                date: (new Date).Format('yyyy-MM')
            });
        }
    };

    // 设备故障， 查看设备详情
    $scope.equipmentDetail = (item, index, event) => {
        if (!event.target.className.includes('clickable')) return;
        const { stid, eqid } = item;
        $scope.$broadcast("equipmentPopUpWp", {
            stid: stid,
            eqid: eqid
        });
    };

    // 风向标
    $scope.wp_station_vane_month_deviceline.subscribe(res => {
        $scope.wp_station_vane_month_deviceline.column = [
            {
                title: '风机',
                dataIndex: 'eq_name',
                sort: true,
                render(text) {
                    return `<span class="clickable">${text}</span>`
                },
            },
            {
                title: '机型',
                dataIndex: 'product_name',
                sort: true,
            },
            {
                title: '偏航误差',
                dataIndex: 'vane_yaw_error',
                sort: true,
            },
            {
                title: '校正后预计提升爬坡效率(%)',
                dataIndex: '',
                width: '40%',
                sort: true,
            },
        ];
    });

    // 风速计
    $scope.wp_station_wsm_month_abnormalrateline.subscribe(res => {
        $scope.wp_station_wsm_month_abnormalrateline.column = [
            {
                title: '风机',
                dataIndex: 'eq_name',
                sort: true,
                render(text) {
                    return `<span class="clickable">${text}</span>`
                },
            },
            {
                title: '机型',
                dataIndex: 'product_name',
                sort: true,
            },
            {
                title: '风速数据异常率(%)',
                dataIndex: '',
                sort: true,
            },
        ];
    });

    // 齿轮箱
    $scope.wp_station_gearbox_month_oilline.subscribe(res => {
        $scope.wp_station_gearbox_month_oilline.column = [
            {
                title: '风机',
                dataIndex: 'eq_name',
                sort: true,
                render(text) {
                    return `<span class="clickable">${text}</span>`
                },
            },
            {
                title: '机型',
                dataIndex: 'product_name',
                sort: true,
            },
            {
                title: '满发油温',
                dataIndex: '',
                sort: true,
            },
        ];
    });


    // 数据置空
    function setDataNull() {
        $scope.wp_station_vane_month_deviceline.res = null;
        $scope.wp_station_wsm_month_abnormalrateline.res = null;
        $scope.wp_station_gearbox_month_oilline.res = null;
    }


    // 键盘 左右 键   切换主题  组合键 放大缩小（ctrl + M）
    $(document).on('keydown', keyChangeTheme);
    $scope.$on('$destroy', () => $(document).off('keydown', keyChangeTheme));
    function keyChangeTheme(event) {
        const { tabIndex } = $scope;
        switch (event.keyCode) {
            case 38:
                if (tabIndex === 0) return;
                $scope.changeTab(tabIndex - 1);
                $scope.$apply();
                break;

            case 40:
                if (tabIndex === 2) return;
                $scope.changeTab(tabIndex + 1);
                $scope.$apply();
                break;

            default:
                break;
        }
    }
    // 销毁 事件
    $scope.$on('$destroy', () => {
        setDataNull();
    });
});