ajaxData(
    {
        pvAlarmGetRunFaultList: {
            name: 'GETpvAlarmGetRunFaultList',
            data: {},
            later:true,
        },
        action_station_clean_suggest_dev_shade_list: {
            name: 'GETaction_station_clean_suggest_dev_shade_list',
            data: {},
            later: true
        },
        action_station_clean_suggest_dev_dr_list: {
            name: 'GETaction_station_clean_suggest_dev_dr_list',
            data: {},
            later: true
        },
        action_station_clean_suggest_dev_decay_list: {
            name: 'GETaction_station_clean_suggest_dev_decay_list',
            data: {},
            later: true
        },
    },
    {
        __serviceName__: 'actionPlanSummaryStationEquipmentMedicalService',
    }
)('actionPlanSummaryStationEquipmentMedicalCtrl', ['$scope', 'actionPlanSummaryStationEquipmentMedicalService',
    'actionRecord'], ($scope, myAjaxData, historicalRecord) => {
        /// 初始化 scope
        $scope.initChildScope($scope, myAjaxData);

        // 主页面初始化完成 回调
        $scope.mainPageInitComplete = async () => {
            let { tabIndex = 0 } = historicalRecord.get().actionPlanSummaryStationEquipmentMedical || {};
            $scope.changeTab(tabIndex);
            $('.ng-clock').removeClass('ng-clock');
            $scope.initComplete = true;
            await myAjaxData.timeout(0);
            await $scope.diffGetData();
            $scope.$apply();
        };

        // 切换电站 回调
        $scope.switchPowerCallback = () => {
            if ($scope.dataType !== 0) return;
            $scope.diffGetData();
        };

        // tab 切换
        $scope.changeTab = tabIndex => {
            $scope.tabIndex = tabIndex;
            historicalRecord.set({
                actionPlanSummaryStationEquipmentMedical: {
                    ...historicalRecord.get().actionPlanSummaryStationEquipmentMedical || {},
                    tabIndex
                }
            });
            $scope.diffGetData();
        };

        // 接口请求
        $scope.diffGetData = async (getInfo) => {
            if (!$scope.initComplete) return;
            await myAjaxData.timeout(0);
            setDataNull(getInfo);
            const { tabIndex, dataType } = $scope;
            if (dataType !== 0) return;
            if (tabIndex === 0) {
                $scope.pvAlarmGetRunFaultList.getData({
                    pageIndex: 0,
                    pageSize: 2000
                });
            } else if (tabIndex === 1) {
                $scope.action_station_clean_suggest_dev_shade_list.getData({
                    queryCode: 'action_station_clean_suggest_dev_shade_list',
                    queryType: 3,
                    date: new Date(Date.now() - 1000 * 24 * 60 * 60).Format('yyyy-MM-dd')
                });
                $scope.action_station_clean_suggest_dev_dr_list.getData({
                    queryCode: 'action_station_clean_suggest_dev_dr_list',
                    queryType: 3,
                    date: new Date(Date.now() - 1000 * 24 * 60 * 60).Format('yyyy-MM-dd')
                });
                $scope.action_station_clean_suggest_dev_decay_list.getData({
                    queryCode: 'action_station_clean_suggest_dev_decay_list',
                    queryType: 3,
                    date: new Date(Date.now() - 1000 * 24 * 60 * 60).Format('yyyy-MM-dd')
                });
            }
        };

        $scope.pvAlarmGetRunFaultList.subscribe(res => {

            $scope.column = [
                {
                    title: '设备名称',
                    dataIndex: 'devicename',
                    align: 'left',
                },
                {
                    title: '故障类型',
                    dataIndex: 'faultlevelStr',
                    align: 'center',
                },
                {
                    title: '故障时间',
                    dataIndex: 'dStartTime',
                    align: 'center',
                    render(text) {
                        return new Date(text).Format('yyyy-MM-dd hh:mm:ss');
                    }
                },
                {
                    title: '设备状态',
                    dataIndex: 'sysstatusStr',
                    align: 'center',
                },
                {
                    title: '故障内容',
                    dataIndex: 'eventDesc',
                    align: 'left',
                    width: '30%',
                },
                {
                    title: '处理状态',
                    dataIndex: 'handstatusStr',
                    align: 'center',
                },
            ];

        });

        $scope.action_station_clean_suggest_dev_shade_list.subscribe(res => {
            $scope.column1 = [
                {
                    title: '设备名称',
                    dataIndex: 'eq_name',
                },
                {
                    title: '阴影损失比例' + '(' + res.body.units.shade_we_r + ')',
                    dataIndex: 'shade_we_r',
                },
            ]
        });

        $scope.action_station_clean_suggest_dev_dr_list.subscribe(res => {
            $scope.column2 = [
                {
                    title: '设备名称',
                    dataIndex: 'eq_name',
                },
                {
                    title: '组串电流离散率' + '(' + res.body.units.c_dr_avg + ')',
                    dataIndex: 'c_dr_avg',
                },
            ]
        });

        $scope.action_station_clean_suggest_dev_decay_list.subscribe(res => {
            $scope.column3 = [
                {
                    title: '设备名称',
                    dataIndex: 'eq_name',
                },
                {
                    title: '累计衰减率' + '(' + res.body.units.decay_r_all + ')',
                    dataIndex: 'decay_r_all',
                },
            ]
        });


        // 数据置空
        function setDataNull(getInfo) {
            // $scope.column = [];
            $scope.action_station_clean_suggest_dev_shade_list.res = null;
            $scope.action_station_clean_suggest_dev_dr_list.res = null;
            $scope.action_station_clean_suggest_dev_decay_list.res = null;
        }


        // 键盘 左右 键   切换主题  组合键 放大缩小（ctrl + M）
        $(document).on('keydown', keyChangeTheme);
        $scope.$on('$destroy', () => $(document).off('keydown', keyChangeTheme));
        function keyChangeTheme(event) {
            const { tabIndex } = $scope;
            switch (event.keyCode) {
                case 38:
                    if (tabIndex === 0) return;
                    $scope.changeTab(tabIndex - 1);
                    $scope.$apply();
                    break;

                case 40:
                    if (tabIndex === 1) return;
                    $scope.changeTab(tabIndex + 1);
                    $scope.$apply();
                    break;

                default:
                    break;
            }
        }
        // 销毁 事件
        $scope.$on('$destroy', () => {
            setDataNull();
        });
    });