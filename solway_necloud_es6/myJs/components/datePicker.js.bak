app.directive('datePicker', ['myAjaxData', (myAjaxData) => ({
    restrict: 'E',
    templateUrl: window.baseUrl + '/tpl/publicComponent/datePicker.html',
    scope: {
        type: '=',
        dateStr: '=',
        updated: '='
    },
    controller($scope) {
        const thisYear = (new Date).getFullYear();
        $scope.years = new Array(20).fill('').map((v, i) => (i < 10) ? (thisYear - 10 + i + '') : (thisYear + i + ''));
        $scope.months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
        $scope.days = new Array(31).fill('').map((v, i) => (i < 9) ? ('0' + (i + 1)) : (i + 1 + ''));
        $scope.hours = new Array(24).fill('').map((v, i) => (i < 10) ? ('0' + i) : (i + ''));
        $scope.minutes = new Array(60).fill('').map((v, i) => (i < 10) ? ('0' + i) : i);
        $scope.seconds = new Array(60).fill('').map((v, i) => (i < 10) ? ('0' + i) : i);
        $scope.year = $scope.month = $scope.day = $scope.hour = $scope.minute = $scope.second = '';

        $scope.$watch('dateStr', (newValue, oldValue) => {
            if (!newValue) return;
            if ($scope.type[0]) {
                $scope.year = $scope.dateStr.substr(0, 4);
                if ($scope.type[1]) {
                    $scope.month = $scope.dateStr.substr(5, 2);
                    if ($scope.type[2]) {
                        $scope.day = $scope.dateStr.substr(8, 2);
                        if ($scope.type[3]) {
                            $scope.hour = $scope.dateStr.substr(11, 2);
                            if ($scope.type[4]) $scope.minute = $scope.dateStr.substr(14, 2);
                        }
                    }
                }
            } else if ($scope.type[1]) {
                $scope.month = $scope.dateStr.substr(0, 2);
                if ($scope.type[2]) {
                    $scope.day = $scope.dateStr.substr(3, 2);
                    if ($scope.type[3]) {
                        $scope.hour = $scope.dateStr.substr(6, 2);
                        if ($scope.type[4]) $scope.minute = $scope.dateStr.substr(9, 2);
                    }
                }
            } else if ($scope.type[2]) {
                $scope.day = $scope.dateStr.substr(0, 2);
                if ($scope.type[3]) {
                    $scope.hour = $scope.dateStr.substr(3, 2);
                    if ($scope.type[4]) $scope.minute = $scope.dateStr.substr(6, 2);
                }
            } else if ($scope.type[3]) {
                $scope.hour = $scope.dateStr.substr(0, 2);
                if ($scope.type[4]) $scope.minute = $scope.dateStr.substr(3, 2);
            } else if ($scope.type[4]) $scope.minute = $scope.dateStr.substr(0, 2);
            if ($scope.type[5]) $scope.second = $scope.dateStr.substr(-2, 2);
        });
        

        $scope.update = async type => {
            if (type === 'month' || type === 'year') {
                let num = 30;
                if (['01','03','05','07','08','10','12'].includes($scope.month)) num = 31;
                else if ($scope.month === '02') num = (($scope.year || thisYear) % 4 === 0) ? 29 : 28;
                $scope.days = new Array(num).fill('').map((v, i) => (i < 9) ? ('0' + (i + 1)) : (i + 1 + ''));
            }
            let { year, month, day, hour, minute, second } = $scope;
            if ($scope.type[0] && year === '') year = thisYear;
            if ($scope.type[1] && month === '') month = '01';
            if ($scope.type[2] && day === '') day = '01';
            if ($scope.type[3] && hour === '') hour = '00';
            if ($scope.type[4] && minute === '') minute = '00';
            if ($scope.type[5] && second === '') second = '00';
            let dateStr = year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second;
            if (!year) dateStr = dateStr.substr(1);
            if (!month) dateStr = dateStr.substr(1);
            if (!day) dateStr = dateStr.substr(1);
            if (!hour) dateStr = dateStr.substr(1);
            if (!minute) dateStr = dateStr.substr(1);
            if (!second) dateStr = dateStr.substr(0, dateStr.length - 1);
            $scope.dateStr = dateStr;
            await myAjaxData.timeout(0);
            $scope.updated && $scope.updated(dateStr);
        };
    }
})]);